<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quản lý sản phẩm - MecWish</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        [x-cloak] { display: none !important; }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-100" x-data="productsManager()">

    <div class="flex h-screen overflow-hidden">
        <!-- SIDEBAR (Giống Dashboard) -->
        <aside class="w-64 bg-white border-r border-gray-200 hidden lg:flex flex-col">
            <div class="h-16 flex items-center justify-center border-b border-gray-100">
                <span class="text-xl font-bold text-blue-600">MECWISH</span>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="dashboard.html" class="flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <i class="fas fa-chart-line w-6"></i> Tổng quan
                </a>
                <a href="products.html" class="flex items-center p-3 bg-blue-50 text-blue-600 font-bold rounded-lg">
                    <i class="fas fa-box w-6"></i> Sản phẩm
                </a>
                <a href="orders.html" class="flex items-center p-3 text-gray-600 hover:bg-gray-50 rounded-lg">
                    <i class="fas fa-shopping-cart w-6"></i> Đơn hàng
                </a>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto p-4 lg:p-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Danh sách sản phẩm</h1>
                <button @click="openModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i> Thêm mới
                </button>
            </div>

            <!-- TABLE -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                        <tr>
                            <th class="px-6 py-3">Ảnh</th>
                            <th class="px-6 py-3">Tên sản phẩm</th>
                            <th class="px-6 py-3">Danh mục</th>
                            <th class="px-6 py-3">Trạng thái</th>
                            <th class="px-6 py-3 text-right">Hành động</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <template x-for="p in products" :key="p.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4">
                                    <img :src="p.images && p.images[0] ? p.images[0] : 'https://via.placeholder.com/50'" class="w-12 h-12 rounded object-cover border">
                                </td>
                                <td class="px-6 py-4 font-medium text-gray-800" x-text="p.name"></td>
                                <td class="px-6 py-4 text-sm text-gray-600" x-text="p.categories?.name"></td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 rounded text-xs font-bold" 
                                          :class="p.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'"
                                          x-text="p.status"></span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <button @click="deleteProduct(p.id)" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="products.length === 0">
                            <td colspan="5" class="px-6 py-8 text-center text-gray-400">Đang tải hoặc chưa có dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- MODAL THÊM SẢN PHẨM -->
    <div x-show="isModalOpen" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" @click="isModalOpen = false"></div>

            <div class="inline-block w-full max-w-2xl p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-xl rounded-2xl relative">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Thêm sản phẩm mới</h3>
                
                <form @submit.prevent="createProduct" class="space-y-4 max-h-[70vh] overflow-y-auto custom-scrollbar pr-2">
                    
                    <!-- Tên & Slug -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên SP</label>
                            <input type="text" x-model="form.name" @input="generateSlug()" class="w-full border border-gray-300 rounded-lg p-2 focus:border-blue-500 outline-none" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Slug (URL)</label>
                            <input type="text" x-model="form.slug" class="w-full border border-gray-300 rounded-lg p-2 bg-gray-50" readonly>
                        </div>
                    </div>

                    <!-- Danh mục & Trạng thái -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Danh mục</label>
                            <select x-model="form.category_id" class="w-full border border-gray-300 rounded-lg p-2 outline-none">
                                <template x-for="c in categories" :key="c.id">
                                    <option :value="c.id" x-text="c.name"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Trạng thái</label>
                            <select x-model="form.status" class="w-full border border-gray-300 rounded-lg p-2 outline-none">
                                <option value="active">Đang bán (Active)</option>
                                <option value="draft">Nháp (Draft)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Gói giá mặc định (Default Variant) -->
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <p class="text-xs font-bold text-blue-600 uppercase mb-2">Cấu hình giá (Gói mặc định)</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-500">Tên gói (VD: 1 Tháng)</label>
                                <input type="text" x-model="form.variant_name" class="w-full border border-gray-300 rounded p-2" required>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Giá bán (VNĐ)</label>
                                <input type="number" x-model="form.price" class="w-full border border-gray-300 rounded p-2 font-bold" required>
                            </div>
                        </div>
                    </div>

                    <!-- Mô tả -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mô tả</label>
                        <textarea x-model="form.description" class="w-full border border-gray-300 rounded-lg p-2 h-24 outline-none"></textarea>
                    </div>

                    <!-- Ảnh (Upload & Link) -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hình ảnh</label>
                        
                        <!-- Cách 1: Dán Link -->
                        <div class="flex gap-2 mb-2">
                            <input type="text" x-model="tempImageUrl" placeholder="Dán link ảnh vào đây..." class="flex-1 border border-gray-300 rounded-lg p-2 text-sm">
                            <button type="button" @click="addImageFromUrl()" class="bg-gray-200 px-3 rounded-lg text-sm font-bold hover:bg-gray-300">Thêm</button>
                        </div>
                        
                        <!-- Cách 2: Upload File -->
                        <div class="mb-2">
                             <label class="cursor-pointer bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-sm font-bold inline-block hover:bg-blue-100">
                                <i class="fas fa-cloud-upload-alt mr-1"></i> Tải ảnh lên
                                <input type="file" @change="uploadImage" class="hidden" accept="image/*">
                            </label>
                            <span x-show="uploading" class="text-sm text-gray-500 ml-2 animate-pulse">Đang tải lên...</span>
                        </div>

                        <!-- Preview Grid -->
                        <div class="grid grid-cols-4 gap-2 mt-2">
                            <template x-for="(img, index) in form.images" :key="index">
                                <div class="relative group aspect-square rounded-lg overflow-hidden border">
                                    <img :src="img" class="w-full h-full object-cover">
                                    <button type="button" @click="removeImage(index)" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" @click="isModalOpen = false" class="px-4 py-2 bg-gray-100 rounded-lg font-bold text-gray-600 hover:bg-gray-200">Hủy</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg" :disabled="isLoading">
                            <span x-show="!isLoading">Lưu sản phẩm</span>
                            <span x-show="isLoading"><i class="fas fa-spinner fa-spin"></i> Xử lý...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script src="../js/supabase.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        function productsManager() {
            return {
                products: [],
                categories: [],
                isModalOpen: false,
                isLoading: false,
                uploading: false,
                tempImageUrl: '',
                
                // Form Data
                form: {
                    name: '',
                    slug: '',
                    category_id: '',
                    description: '',
                    status: 'active',
                    images: [],
                    // Variant Info
                    variant_name: '1 Tháng',
                    price: ''
                },

                async init() {
                    this.fetchCategories();
                    this.fetchProducts();
                },

                async fetchCategories() {
                    const { data } = await supabase.from('categories').select('*');
                    if (data) {
                        this.categories = data;
                        if(data.length > 0) this.form.category_id = data[0].id;
                    }
                },

                async fetchProducts() {
                    // Lấy sản phẩm kèm tên danh mục
                    const { data } = await supabase
                        .from('products')
                        .select('*, categories(name)')
                        .order('created_at', { ascending: false });
                    if (data) this.products = data;
                },

                openModal() {
                    this.resetForm();
                    this.isModalOpen = true;
                },

                generateSlug() {
                    // Chuyển tên thành slug: "Netflix Premium" -> "netflix-premium"
                    const slug = this.form.name.toLowerCase()
                        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                        .replace(/[đĐ]/g, "d")
                        .replace(/[^a-z0-9\s]/g, "")
                        .replace(/\s+/g, "-");
                    this.form.slug = slug + '-' + Math.floor(Math.random() * 1000); // Thêm số ngẫu nhiên để tránh trùng
                },

                addImageFromUrl() {
                    if(this.tempImageUrl) {
                        this.form.images.push(this.tempImageUrl);
                        this.tempImageUrl = '';
                    }
                },

                removeImage(index) {
                    this.form.images.splice(index, 1);
                },

                async uploadImage(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    this.uploading = true;
                    const fileName = Date.now() + '-' + file.name.replace(/[^a-zA-Z0-9.]/g, ''); // Tên file an toàn
                    
                    // Upload vào Bucket 'mecwish_images'
                    const { data, error } = await supabase.storage
                        .from('mecwish_images')
                        .upload(fileName, file);

                    if (error) {
                        alert('Lỗi upload: ' + error.message);
                    } else {
                        // Lấy Public URL
                        const { data: { publicUrl } } = supabase.storage
                            .from('mecwish_images')
                            .getPublicUrl(fileName);
                        this.form.images.push(publicUrl);
                    }
                    this.uploading = false;
                },

                async createProduct() {
                    this.isLoading = true;

                    // 1. Tạo Sản phẩm vào bảng 'products'
                    const { data: prodData, error: prodError } = await supabase
                        .from('products')
                        .insert([{
                            name: this.form.name,
                            slug: this.form.slug,
                            category_id: this.form.category_id,
                            description: this.form.description,
                            status: this.form.status,
                            images: this.form.images,
                            is_featured: true
                        }])
                        .select()
                        .single();

                    if (prodError) {
                        alert('Lỗi tạo SP: ' + prodError.message);
                        this.isLoading = false;
                        return;
                    }

                    // 2. Tạo Gói giá vào bảng 'product_variants'
                    const { error: varError } = await supabase
                        .from('product_variants')
                        .insert([{
                            product_id: prodData.id,
                            name: this.form.variant_name,
                            price: this.form.price,
                            stock_status: true
                        }]);

                    if (varError) {
                        alert('Lỗi tạo giá: ' + varError.message);
                    } else {
                        alert('Thêm sản phẩm thành công!');
                        this.isModalOpen = false;
                        this.fetchProducts(); // Load lại bảng
                    }
                    this.isLoading = false;
                },
                
                async deleteProduct(id) {
                    if(confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                        await supabase.from('products').delete().eq('id', id);
                        this.fetchProducts();
                    }
                },

                resetForm() {
                    this.form = {
                        name: '', slug: '', description: '', status: 'active', images: [],
                        variant_name: '1 Tháng', price: '',
                        category_id: this.categories.length > 0 ? this.categories[0].id : ''
                    };
                }
            }
        }
    </script>
</body>
</html>
