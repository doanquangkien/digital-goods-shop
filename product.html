<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chi tiết sản phẩm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; } [x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-50 text-gray-800 pb-24" x-data="productDetailApp()">

    <!-- HEADER: Nút Back -->
    <header class="fixed top-0 inset-x-0 z-40 bg-white shadow-sm h-14 flex items-center px-4">
        <a href="javascript:history.back()" class="text-gray-600 hover:text-blue-600"><i class="fas fa-arrow-left text-xl"></i></a>
        <h1 class="ml-4 font-bold text-lg truncate" x-text="product?.name || 'Đang tải...'"></h1>
    </header>

    <main class="mt-14 px-4 max-w-4xl mx-auto pt-4" x-show="!loading" x-cloak>
        
        <!-- 1. ẢNH SẢN PHẨM (Grid 1 ảnh lớn) -->
        <div class="bg-white p-1 rounded-2xl shadow-sm border border-gray-100 mb-6">
            <div class="aspect-video rounded-xl overflow-hidden bg-gray-200">
                <img :src="currentImage" class="w-full h-full object-cover">
            </div>
            <!-- Thumbnails (Nếu có nhiều ảnh) -->
            <div class="flex gap-2 mt-2 overflow-x-auto p-1" x-show="product.images && product.images.length > 1">
                <template x-for="img in product.images">
                    <img :src="img" @click="currentImage = img" class="w-16 h-16 rounded-lg object-cover border-2 cursor-pointer transition" :class="currentImage === img ? 'border-blue-500' : 'border-transparent'">
                </template>
            </div>
        </div>

        <!-- 2. THÔNG TIN & CHỌN GÓI -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
            <h1 class="text-2xl font-bold text-gray-900 leading-tight mb-2" x-text="product.name"></h1>
            <div class="flex items-center gap-2 mb-4">
                <span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded">Còn hàng</span>
                <span class="text-xs text-gray-500">Đã bán: 142</span>
            </div>

            <hr class="border-gray-100 mb-4">

            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Chọn gói dịch vụ:</label>
            <div class="space-y-3">
                <template x-for="variant in variants" :key="variant.id">
                    <div @click="selectedVariant = variant" 
                         class="border rounded-xl p-3 cursor-pointer flex justify-between items-center transition relative overflow-hidden"
                         :class="selectedVariant?.id === variant.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-300'">
                        
                        <div>
                            <span class="block font-bold text-gray-800" x-text="variant.name"></span>
                            <span class="text-xs text-gray-400 line-through" x-show="variant.original_price" x-text="formatCurrency(variant.original_price)"></span>
                        </div>
                        <span class="font-bold text-blue-600 text-lg" x-text="formatCurrency(variant.price)"></span>
                        
                        <!-- Check icon -->
                        <div x-show="selectedVariant?.id === variant.id" class="absolute top-0 right-0 bg-blue-500 text-white w-6 h-6 rounded-bl-xl flex items-center justify-center text-xs">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- 3. MÔ TẢ CHI TIẾT -->
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-6">
            <h3 class="font-bold text-gray-800 mb-3">Mô tả sản phẩm</h3>
            <div class="text-gray-600 text-sm leading-relaxed whitespace-pre-line" x-text="product.description"></div>
        </div>

        <!-- 4. SẢN PHẨM TƯƠNG TỰ -->
        <div x-show="relatedProducts.length > 0">
            <h3 class="font-bold text-gray-800 mb-3 text-lg">Sản phẩm tương tự</h3>
            <div class="grid grid-cols-2 gap-4">
                <template x-for="rel in relatedProducts" :key="rel.id">
                    <a :href="`product.html?id=${rel.id}`" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100">
                        <img :src="rel.images[0]" class="w-full h-32 object-cover rounded-lg mb-2 bg-gray-100">
                        <h4 class="font-bold text-sm truncate" x-text="rel.name"></h4>
                        <p class="text-blue-600 font-bold text-sm mt-1" x-text="formatCurrency(rel.min_price)"></p>
                    </a>
                </template>
            </div>
        </div>

    </main>

    <!-- BOTTOM BAR (MUA HÀNG) -->
    <div class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 p-3 flex gap-3 z-50 items-center safe-area-bottom">
        <div class="flex-1">
            <p class="text-xs text-gray-500">Tổng tiền:</p>
            <p class="text-xl font-bold text-blue-600" x-text="selectedVariant ? formatCurrency(selectedVariant.price) : '---'"></p>
        </div>
        <button class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition"
                :disabled="!selectedVariant"
                :class="!selectedVariant ? 'opacity-50 cursor-not-allowed' : ''">
            Mua Ngay
        </button>
    </div>

    <script src="../js/supabase.js"></script>
    <script>
        function productDetailApp() {
            return {
                loading: true,
                product: {},
                variants: [],
                relatedProducts: [],
                selectedVariant: null,
                currentImage: '',

                async init() {
                    const productId = getQueryParam('id');
                    if(!productId) { alert('Sản phẩm không tồn tại'); return; }

                    // 1. Lấy thông tin Sản phẩm & Các gói giá (Variants)
                    const { data, error } = await supabase
                        .from('products')
                        .select('*, product_variants(*)')
                        .eq('id', productId)
                        .single();

                    if(data) {
                        this.product = data;
                        this.variants = data.product_variants.sort((a,b) => a.price - b.price); // Sắp xếp giá tăng dần
                        this.currentImage = data.images[0];
                        if(this.variants.length > 0) this.selectedVariant = this.variants[0]; // Tự chọn gói rẻ nhất

                        // 2. Lấy sản phẩm tương tự (Cùng category, khác ID hiện tại)
                        this.fetchRelated(data.category_id, data.id);
                    }
                    this.loading = false;
                },

                async fetchRelated(catId, currentId) {
                    const { data } = await supabase
                        .from('products')
                        .select('*, product_variants(price)')
                        .eq('category_id', catId)
                        .neq('id', currentId)
                        .eq('status', 'active')
                        .limit(4);
                    
                    if(data) {
                        this.relatedProducts = data.map(p => {
                            const prices = p.product_variants.map(v => v.price);
                            return { ...p, min_price: prices.length > 0 ? Math.min(...prices) : 0 };
                        });
                    }
                }
            }
        }
    </script>
</body>
</html>
